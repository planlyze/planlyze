import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    const user = await base44.auth.me();

    if (!user) {
      return Response.json({ error: 'Unauthorized' }, { status: 401 });
    }
    if (user.role !== 'admin') {
      return Response.json({ error: 'Forbidden' }, { status: 403 });
    }

    const payload = await req.json().catch(() => ({}));
    const order = payload?.order || '-updated_date';
    const limit = Number(payload?.limit ?? 10000);
    const skip = Number(payload?.skip ?? 0);
    const userEmail = payload?.userEmail;

    const filter = {};
    if (userEmail) filter.created_by = userEmail;

    // Fetch all matching analyses with explicit error handling
    let allItems;
    try {
      if (userEmail) {
        // If filtering by user, use the filter method
        allItems = await base44.asServiceRole.entities.Analysis.filter(filter, order);
      } else {
        // If fetching all, use list method which is more reliable
        allItems = await base44.asServiceRole.entities.Analysis.list(order, limit * 10);
      }
    } catch (fetchError) {
      console.error('Error fetching analyses from SDK:', fetchError);
      // Return empty array on SDK error
      return Response.json({ 
        items: [], 
        total: 0, 
        skip: skip, 
        limit: limit,
        error: fetchError?.message || 'Failed to fetch analyses'
      }, { status: 200 });
    }
    
    // Validate that we got an array
    if (!Array.isArray(allItems)) {
      console.error('Analysis filter/list did not return an array:', typeof allItems);
      console.error('Actual value:', JSON.stringify(allItems).substring(0, 200));
      
      // If it's a string error message, return it
      if (typeof allItems === 'string') {
        return Response.json({ 
          items: [], 
          total: 0, 
          skip: skip, 
          limit: limit,
          error: allItems
        }, { status: 200 });
      }
      
      return Response.json({ 
        items: [], 
        total: 0, 
        skip: skip, 
        limit: limit,
        error: 'SDK returned non-array response'
      }, { status: 200 });
    }

    const total = allItems.length;

    // Apply pagination manually
    const paginatedItems = allItems.slice(skip, skip + limit);

    return Response.json({ 
      items: paginatedItems,
      total: total,
      skip: skip,
      limit: limit
    }, { status: 200 });
  } catch (error) {
    console.error('listAllAnalysesAdmin error:', error);
    return Response.json({ 
      error: error?.message || 'Internal error',
      items: [],
      total: 0,
      skip: 0,
      limit: 0
    }, { status: 500 });
  }
});