import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS'
};

Deno.serve(async (req) => {
  try {
    if (req.method === 'OPTIONS') {
      return new Response(null, { status: 204, headers: corsHeaders });
    }
    if (req.method !== 'POST') {
      return Response.json({ error: 'Method Not Allowed' }, { status: 405, headers: corsHeaders });
    }

    const base44 = createClientFromRequest(req);
    const body = await req.json().catch(() => ({}));
    const email = String(body?.email || '').trim().toLowerCase();
    const submitted = String(body?.code || '').trim();

    if (!email || !submitted) {
      return Response.json({ error: 'Email and code are required' }, { status: 400, headers: corsHeaders });
    }

    // Fetch target user as service role to support unauthenticated reset
    const users = await base44.asServiceRole.entities.User.filter({ email });
    const user = Array.isArray(users) ? users[0] : null;

    // Do not reveal user existence
    if (!user) {
      // respond as if checked
      return Response.json({ ok: false, reason: 'mismatch' }, { status: 200, headers: corsHeaders });
    }

    const stored = user.reset_password_code || '';
    const expiresAt = user.reset_password_expires_at ? new Date(user.reset_password_expires_at) : null;
    const now = new Date();

    if (!stored) {
      return Response.json({ ok: false, reason: 'no_code' }, { status: 200, headers: corsHeaders });
    }
    if (expiresAt && now > expiresAt) {
      // clear expired code
      await base44.asServiceRole.entities.User.update(user.id, {
        reset_password_code: null,
        reset_password_expires_at: null
      });
      return Response.json({ ok: false, reason: 'expired' }, { status: 200, headers: corsHeaders });
    }

    const success = stored === submitted;
    if (!success) {
      return Response.json({ ok: false, reason: 'mismatch' }, { status: 200, headers: corsHeaders });
    }

    // Mark as verified and clear code
    await base44.asServiceRole.entities.User.update(user.id, {
      reset_password_code: null,
      reset_password_expires_at: null,
      reset_code_verified_at: new Date().toISOString()
    });

    return Response.json({ ok: true }, { status: 200, headers: corsHeaders });
  } catch (error) {
    return Response.json({ error: error?.message || 'Verification failed' }, { status: 500, headers: corsHeaders });
  }
});