
import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS'
};

const ALLOWED_EXPERIENCE = new Set(['beginner', 'intermediate', 'experienced', 'expert']);
const ALLOWED_LANGS = new Set(['english', 'arabic']);
const DEFAULT_COUNTRY = 'Syria';
const ALLOWED_INDUSTRIES = new Set([
  "Delivery",
  "BeautyEcommerce",
  "ClothesEcommerce",
  "ElectronicsEcommerce",
  "FoodEcommerce",
  "MedicineEcommerce",
  "StuffEcommerce",
  "SupermarketEcommerce",
  "GeneralHealth",
  "JobOppurtunity", // Added to prevent fallback to 'Other'
  "SellRentCars",
  "SellRentRealestate",
  "ServicesTaxi",
  "Other"
]);

Deno.serve(async (req) => {
  try {
    // Only allow POST (SDK calls POST). Helpful for debugging via dashboard.
    // CORS preflight
    if (req.method === 'OPTIONS') {
      return new Response(null, { status: 204, headers: corsHeaders });
    }
    if (req.method !== 'POST') {
      return Response.json({ error: 'Method Not Allowed' }, { status: 405, headers: corsHeaders });
    }

    const base44 = createClientFromRequest(req);
    const user = await base44.auth.me();
    if (!user) {
      return Response.json({ error: 'Unauthorized' }, { status: 401, headers: corsHeaders });
    }

    let body = {};
    try {
      body = await req.json();
    } catch {
      return Response.json({ error: 'Invalid JSON payload' }, { status: 400, headers: corsHeaders });
    }

    // Extract and sanitize inputs
    const rawIdea = typeof body.business_idea === 'string' ? body.business_idea : '';
    const business_idea = rawIdea.trim();

    const rawExp = typeof body.experience_level === 'string' ? body.experience_level.toLowerCase() : '';
    const experience_level = ALLOWED_EXPERIENCE.has(rawExp) ? rawExp : 'beginner';

    const rawLang = typeof body.report_language === 'string' ? body.report_language.toLowerCase() : '';
    const report_language = ALLOWED_LANGS.has(rawLang) ? rawLang : 'english';

    const rawCountry = typeof body.country === 'string' ? body.country : '';
    const country = (rawCountry || DEFAULT_COUNTRY).trim() || DEFAULT_COUNTRY;

    const rawIndustry = typeof body.industry === 'string' ? body.industry : '';
    const industry = ALLOWED_INDUSTRIES.has(rawIndustry) ? rawIndustry : 'Other';
    const custom_industry = typeof body.custom_industry === 'string' ? body.custom_industry.trim() : '';

    // Basic validations
    if (!business_idea || business_idea.length < 5) {
      return Response.json({ error: 'business_idea is required (min 5 chars)' }, { status: 400, headers: corsHeaders });
    }
    if (industry === 'Other' && !custom_industry) {
      return Response.json({ error: 'Please provide your industry in custom_industry when industry is Other' }, { status: 400, headers: corsHeaders });
    }

    // Create initial record (client handles chained generation)
    const analysis = await base44.entities.Analysis.create({
      business_idea,
      experience_level,
      report_language,
      country,
      industry,
      custom_industry: industry === 'Other' ? custom_industry : null,
      status: 'analyzing',
      report_generated: false,
      progress_percent: 10,
      last_error: null
    });

    // Keep returning the raw analysis object for frontend compatibility
    return Response.json(analysis, { status: 201, headers: corsHeaders });
  } catch (error) {
    return Response.json({ error: error?.message || 'Creation failed' }, { status: 500, headers: corsHeaders });
  }
});
