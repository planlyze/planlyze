import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import nodemailer from 'npm:nodemailer@6.9.8';

function generateCode() {
  return String(Math.floor(100000 + Math.random() * 900000));
}

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS'
};

Deno.serve(async (req) => {
  try {
    if (req.method === 'OPTIONS') {
      return new Response(null, { status: 204, headers: corsHeaders });
    }
    if (req.method !== 'POST') {
      return Response.json({ error: 'Method Not Allowed' }, { status: 405, headers: corsHeaders });
    }

    const base44 = createClientFromRequest(req);
    let me = null;
    try { me = await base44.auth.me(); } catch { /* unauthenticated flow allowed */ }

    const body = await req.json().catch(() => ({}));
    const purpose = (body?.purpose || '').toLowerCase(); // 'verify' | 'reset'
    // If user is not logged in, default to password reset flow.
    const isResetFlow = !me || purpose === 'reset';
    const isVerifyFlow = !!me && purpose === 'verify';

    // Resolve target email
    const targetEmail = (body?.email || (me?.email ?? '')).trim().toLowerCase();
    if (!targetEmail) {
      // avoid user enumeration: generic response
      return Response.json({ ok: true }, { status: 200, headers: corsHeaders });
    }

    // Look up user as service role (works when unauthenticated)
    const users = await base44.asServiceRole.entities.User.filter({ email: targetEmail });
    const user = Array.isArray(users) ? users[0] : null;

    // Do not reveal whether the email exists to prevent enumeration
    if (!user) {
      return Response.json({ ok: true }, { status: 200, headers: corsHeaders });
    }

    // Rate limit resend: 60s for reset flow
    if (isResetFlow && user.reset_code_last_sent_at) {
      const last = new Date(user.reset_code_last_sent_at).getTime();
      if (Date.now() - last < 60_000) {
        return Response.json({ ok: true, throttled: true, retry_after_seconds: 60 }, { status: 200, headers: corsHeaders });
      }
    }

    // Generate code and expiry (10 minutes)
    const code = generateCode();
    const expiresAt = new Date(Date.now() + 10 * 60 * 1000).toISOString();

    // Persist code on user record
    if (isVerifyFlow) {
      await base44.asServiceRole.entities.User.update(user.id, {
        email_verification_code: code,
        email_verification_expires_at: expiresAt,
        email_verified: false
      });
    } else {
      await base44.asServiceRole.entities.User.update(user.id, {
        reset_password_code: code,
        reset_password_expires_at: expiresAt,
        reset_code_last_sent_at: new Date().toISOString()
      });
    }

    // SMTP configuration
    const host = Deno.env.get('SMTP_HOST');
    const portStr = Deno.env.get('SMTP_PORT') || '587';
    const userEnv = Deno.env.get('SMTP_USER');
    const passEnv = Deno.env.get('SMTP_PASS');
    const fromEmail = Deno.env.get('SMTP_FROM_EMAIL') || userEnv || '';
    const fromName = Deno.env.get('SMTP_FROM_NAME') || 'Planlyze';

    if (!host || !portStr || !userEnv || !passEnv) {
      return Response.json({ error: 'SMTP not configured (Missing SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS)' }, { status: 500, headers: corsHeaders });
    }

    const port = Number(portStr);
    const secure = port === 465; // SSL for 465, STARTTLS for 587

    const transporter = nodemailer.createTransport({
      host,
      port,
      secure,
      auth: { user: userEnv, pass: passEnv },
      requireTLS: !secure && port === 587,
      authMethod: 'LOGIN',
      tls: { minVersion: 'TLSv1.2' }
    });

    const subject = isVerifyFlow ? 'Your Planlyze verification code' : 'Your Planlyze password reset code';
    const text = `Your ${isVerifyFlow ? 'verification' : 'password reset'} code is: ${code}\n\nThis code will expire in 10 minutes.`;
    const html = `
      <div style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; line-height:1.6; color:#0f172a;">
        <h2 style="margin:0 0 12px;">${isVerifyFlow ? 'Email Verification' : 'Password Reset'}</h2>
        <p>Your ${isVerifyFlow ? 'verification' : 'password reset'} code is:</p>
        <p style="font-size:20px; font-weight:700; letter-spacing:2px;">${code}</p>
        <p>This code will expire in 10 minutes.</p>
      </div>
    `;

    await transporter.sendMail({
      from: fromName ? `"${fromName}" <${fromEmail}>` : fromEmail,
      to: targetEmail,
      subject,
      text,
      html
    });

    return Response.json({ ok: true }, { status: 200, headers: corsHeaders });
  } catch (error) {
    return Response.json({ error: error?.message || 'Failed to send code' }, { status: 500, headers: corsHeaders });
  }
});