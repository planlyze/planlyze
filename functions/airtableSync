import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    const me = await base44.auth.me();
    if (!me) {
      return Response.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const AIRTABLE_API_KEY = Deno.env.get('AIRTABLE_API_KEY');
    const AIRTABLE_BASE_ID = Deno.env.get('AIRTABLE_BASE_ID');
    const AIRTABLE_TABLE_NAME = Deno.env.get('AIRTABLE_TABLE_NAME');

    if (!AIRTABLE_API_KEY || !AIRTABLE_BASE_ID || !AIRTABLE_TABLE_NAME) {
      return Response.json({ error: 'Airtable is not configured. Missing one of AIRTABLE_API_KEY, AIRTABLE_BASE_ID, AIRTABLE_TABLE_NAME.' }, { status: 500 });
    }

    // If already synced, short-circuit
    if (me.airtable_synced === true) {
      return Response.json({ ok: true, already_synced: true }, { status: 200 });
    }

    const fields = {
      Name: me.display_name || me.full_name || me.email,
      Email: me.email,
      Role: me.role,
      "Signup Date": me.created_date || new Date().toISOString(),
      "Last Login": me.last_login || null,
      "Preferred Language": me.preferred_language || null,
      Phone: me.phone_number || null,
      Country: me.country || null,
      City: me.city || null,
      "User ID": me.id || null,
      "Source App Id": Deno.env.get('BASE44_APP_ID') || null
    };

    const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(AIRTABLE_TABLE_NAME)}`;
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ fields })
    });

    if (!res.ok) {
      const errText = await res.text();
      return Response.json({ error: 'Airtable request failed', details: errText }, { status: res.status });
    }

    const airtableResp = await res.json();

    // Mark user as synced to avoid duplicates in future logins
    await base44.auth.updateMe({ airtable_synced: true });

    return Response.json({ ok: true, airtable: airtableResp }, { status: 200 });
  } catch (error) {
    return Response.json({ error: error?.message || 'Internal error' }, { status: 500 });
  }
});