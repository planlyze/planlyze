import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    const me = await base44.auth.me();
    if (!me) return Response.json({ error: 'Unauthorized' }, { status: 401 });

    const body = await req.json().catch(() => ({}));
    const submitted = String(body?.code || '').trim();

    if (!submitted) return Response.json({ error: 'Code is required' }, { status: 400 });

    // Fetch my full user record (includes custom fields)
    const users = await base44.entities.User.filter({ id: me.id });
    const my = Array.isArray(users) ? users[0] : null;
    if (!my) return Response.json({ error: 'User not found' }, { status: 404 });

    const stored = my.email_verification_code || '';
    const expiresAt = my.email_verification_expires_at ? new Date(my.email_verification_expires_at) : null;
    const now = new Date();

    if (!stored) return Response.json({ ok: false, reason: 'no_code' }, { status: 200 });
    if (expiresAt && now > expiresAt) {
      // expire and clear code
      await base44.entities.User.update(me.id, {
        email_verification_code: null,
        email_verification_expires_at: null
      });
      return Response.json({ ok: false, reason: 'expired' }, { status: 200 });
    }

    const success = stored === submitted;
    if (!success) {
      return Response.json({ ok: false, reason: 'mismatch' }, { status: 200 });
    }

    await base44.entities.User.update(me.id, {
      email_verified: true,
      email_verification_code: null,
      email_verification_expires_at: null
    });

    return Response.json({ ok: true });
  } catch (error) {
    return Response.json({ error: error?.message || 'Verification failed' }, { status: 500 });
  }
});